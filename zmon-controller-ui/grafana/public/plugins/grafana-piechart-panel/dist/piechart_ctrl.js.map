{"version":3,"sources":["../src/piechart_ctrl.js"],"names":[],"mappings":"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","file":"piechart_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport TimeSeries from 'app/core/time_series';\nimport rendering from './rendering';\nimport legend from './legend';\n\nexport class PieChartCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope) {\n    super($scope, $injector);\n    this.$rootScope = $rootScope;\n\n    var panelDefaults = {\n      pieType: 'pie',\n      legend: {\n        show: true, // disable/enable legend\n        values: true\n      },\n      links: [],\n      datasource: null,\n      maxDataPoints: 3,\n      interval: null,\n      targets: [{}],\n      cacheTimeout: null,\n      nullPointMode: 'connected',\n      legendType: 'Under graph',\n      aliasColors: {},\n      format: 'short',\n      valueName: 'current',\n      strokeWidth: 1,\n      fontSize: '80%'\n    };\n\n    _.defaults(this.panel, panelDefaults);\n    _.defaults(this.panel.legend, panelDefaults.legend);\n\n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/grafana-piechart-panel/editor.html', 2);\n    this.unitFormats = kbn.getUnitFormats();\n  }\n\n  setUnitFormat(subItem) {\n    this.panel.format = subItem.value;\n    this.render();\n  }\n\n  onDataError() {\n    this.series = [];\n    this.render();\n  }\n\n  changeSeriesColor(series, color) {\n    series.color = color;\n    this.panel.aliasColors[series.alias] = series.color;\n    this.render();\n  }\n\n  onRender() {\n    this.data = this.parseSeries(this.series);\n  }\n\n  parseSeries(series) {\n    return _.map(this.series, (serie, i) => {\n      return {\n        label: serie.alias,\n        data: serie.stats[this.panel.valueName],\n        color: this.panel.aliasColors[serie.alias] || this.$rootScope.colors[i]\n      };\n    });\n  }\n\n  onDataReceived(dataList) {\n    this.series = dataList.map(this.seriesHandler.bind(this));\n    this.data = this.parseSeries(this.series);\n    this.render(this.data);\n  }\n\n  seriesHandler(seriesData) {\n    var series = new TimeSeries({\n      datapoints: seriesData.datapoints,\n      alias: seriesData.target\n    });\n\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    return series;\n  }\n\n  getDecimalsForValue(value) {\n    if (_.isNumber(this.panel.decimals)) {\n      return { decimals: this.panel.decimals, scaledDecimals: null };\n    }\n\n    var delta = value / 2;\n    var dec = -Math.floor(Math.log(delta) / Math.LN10);\n\n    var magn = Math.pow(10, -dec);\n    var norm = delta / magn; // norm is between 1.0 and 10.0\n    var size;\n\n    if (norm < 1.5) {\n      size = 1;\n    } else if (norm < 3) {\n      size = 2;\n      // special case for 2.5, requires an extra decimal\n      if (norm > 2.25) {\n        size = 2.5;\n        ++dec;\n      }\n    } else if (norm < 7.5) {\n      size = 5;\n    } else {\n      size = 10;\n    }\n\n    size *= magn;\n\n    // reduce starting decimals if not needed\n    if (Math.floor(value) === value) { dec = 0; }\n\n    var result = {};\n    result.decimals = Math.max(0, dec);\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\n\n    return result;\n  }\n\n  formatValue(value) {\n    var decimalInfo = this.getDecimalsForValue(value);\n    var formatFunc = kbn.valueFormats[this.panel.format];\n    if (formatFunc) {\n      return formatFunc(value, decimalInfo.decimals, decimalInfo.scaledDecimals);\n    }\n    return value;\n  }\n\n  link(scope, elem, attrs, ctrl) {\n    rendering(scope, elem, attrs, ctrl);\n  }\n}\n\nPieChartCtrl.templateUrl = 'module.html';\n"]}